<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>üõ°Ô∏è Compapol ‚Ä¢ Away</title>
<style>
  :root{
    /* Cambia esta ruta por tu imagen */
    --bg-img: url('img/bg_patrol.jpg');

    --txt:#fff; --muted:#b5b5b5;
    --line:#2b5fff;               /* azul patrulla para bordes */
    --ok:#22c55e; --danger:#ef4444;
    --glass: rgba(25,25,25,.78);  /* ‚Äúvidrio ahumado‚Äù de paneles */
    --field: rgba(20,20,20,.8);   /* campos */
    --glow-blue: 0 0 6px rgba(43,95,255,.7), 0 0 14px rgba(43,95,255,.5);
    --glow-green: 0 0 6px rgba(16,185,129,.7), 0 0 14px rgba(16,185,129,.5);
    --glow-red: 0 0 6px rgba(239,68,68,.8), 0 0 14px rgba(239,68,68,.6);
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body{ height:100%; }
  body{
    margin:0; color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    /* Fondo a pantalla completa, fijo y cubriendo */
    background: #000;
  }
  /* Capa: imagen de fondo fija */
  body::before{
    content:""; position:fixed; inset:0; z-index:-2;
    background-image: var(--bg-img);
    background-size: cover; background-position: center; background-attachment: fixed;
    transform: translateZ(0);
  }
  /* Capa: velo oscuro transl√∫cido para contraste */
  body::after{
    content:""; position:fixed; inset:0; z-index:-1;
    background: rgba(0,0,0,.55);   /* ajusta opacidad si quieres m√°s/menos fondo */
    backdrop-filter: blur(2px);    /* leve desenfoque del fondo */
  }

  /* Encabezado con ne√≥n azul */
  header{
    position:sticky; top:0; z-index:10; padding:14px 12px;
    background: rgba(10,14,41,.65);
    border-bottom:1px solid var(--line);
    box-shadow: var(--glow-blue);
  }
  h1{
    margin:0; text-align:center; font-weight:800; letter-spacing:.3px; font-size:17px;
    color:#dfe8ff;
    text-shadow:0 0 6px rgba(120,160,255,.8),0 0 14px rgba(70,120,255,.6);
  }

  .wrap{ padding:12px; max-width:820px; margin:0 auto; width:100%; }

  /* Contenedor principal en vidrio ahumado */
  .glass{
    background: var(--glass);
    border:1px solid var(--line);
    border-radius:14px;
    box-shadow: var(--glow-blue);
    padding:10px;
  }

  /* Botonera: 5 botones reparti√©ndose el 100% del ancho */
  .bar{
    display:grid;
    grid-template-columns:repeat(5, minmax(0,1fr)); /* üé§ ‚è∏Ô∏è üèõÔ∏è üßπ üíæ */
    gap:8px; width:100%; margin-bottom:10px;
  }
  @media (max-width:420px){ .bar{ gap:6px; } }

  .btn{
    height:42px; border:1px solid var(--line);
    background: rgba(10,14,41,.7);
    color:var(--txt); border-radius:12px; font-size:16px;
    display:inline-flex; align-items:center; justify-content:center;
    box-shadow: var(--glow-blue);
    -webkit-appearance:none;
    transition: box-shadow .12s ease, border-color .12s ease, transform .08s ease;
  }
  .btn:active{ transform:translateY(1px); }
  .btn.flash-red{ border-color: var(--danger) !important; box-shadow: var(--glow-red) !important; }

  textarea{
    width:100%; min-height:200px; background: var(--glass); color:var(--txt);
    border:1px solid var(--line); border-radius:12px; padding:10px; font-size:15px;
    box-shadow: var(--glow-blue);
  }
  textarea::placeholder{ color:var(--muted); opacity:.35; }

  .status{ font-size:12px; color:var(--muted); min-height:18px; margin:6px 2px 10px; }

  .out{
    min-height:180px; background: var(--glass); border:1px solid var(--line);
    border-radius:12px; padding:10px; box-shadow: var(--glow-blue);
  }

  .accordion{ border:1px solid var(--line); border-radius:12px; overflow:hidden; margin:10px 0; box-shadow: var(--glow-blue); background: var(--glass); }
  .acc-h{
    background: rgba(10,14,41,.55);
    padding:10px; display:flex; align-items:center; justify-content:space-between; font-size:14px;
  }
  .acc-c{ background: transparent; padding:10px; display:none; }
  .acc-c.show{ display:block; }

  /* T√≠tulo centrado con tri√°ngulos */
  .acc-title{
    flex:1; text-align:center; font-weight:600; letter-spacing:.2px;
  }
  .acc-title::before{ content:"‚óÑ"; margin-right:8px; opacity:.7; }
  .acc-title::after { content:"‚ñ∫"; margin-left:8px; opacity:.7; }

  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; width:100%; }
  input[type="text"], select{
    width:100%; height:38px; border-radius:10px; border:1px solid var(--line);
    background: var(--field); color:var(--txt); padding:0 10px; font-size:14px;
    box-shadow: inset 0 0 0 1px rgba(43,95,255,.08);
  }
  input::placeholder{ color:var(--muted); opacity:.35; }
  select{ color:var(--txt); background: var(--field); }

  .list{ margin-top:8px; display:grid; gap:6px; width:100%; }
  .rowItem{
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding:6px 8px; background: rgba(20,20,20,.75); border:1px solid var(--line); border-radius:10px; font-size:13px;
  }

  /* Botones verdes (A√±adir/Importar) con brillo propio */
  .btn-green{
    border-color:#10b981; box-shadow: var(--glow-green);
    background: rgba(14,42,37,.8);
    font-size:14px; height:34px; padding:0 10px; border-radius:10px;
  }

  /* T√≠tulo de secci√≥n centrado (Versi√≥n Policial) */
  .section-title{
    margin:10px 0 6px;
    text-align:center;
    font-weight:700;
    text-shadow:0 0 6px rgba(120,160,255,.6);
  }
</style>
</head>
<body>
<header><h1>üõ°Ô∏è Compapol ‚Ä¢ Away</h1></header>

<div class="wrap glass">
  <!-- Botonera (solo iconos) -->
  <div class="bar" id="topBar">
    <button id="btnRec" class="btn" title="Grabar" aria-label="Grabar">üé§</button>
    <button id="btnRecStop" class="btn" title="Parar" aria-label="Parar">‚è∏Ô∏è</button>
    <button id="btnDraft" class="btn" title="Redacci√≥n policial" aria-label="Redacci√≥n policial">üèõÔ∏è</button>
    <button id="btnClear" class="btn" title="Limpiar" aria-label="Limpiar">üßπ</button>
    <button id="btnDownload" class="btn" title="Guardar JSON" aria-label="Guardar JSON">üíæ</button>
  </div>

  <!-- Filiaciones -->
  <div class="accordion" id="accFili">
    <div class="acc-h">
      <span class="acc-title">Filiaciones</span>
    </div>
    <div class="acc-c" id="accBody">
      <div class="grid2">
        <select id="fiCondicion" title="Condici√≥n" required>
          <option value="" disabled selected>Condici√≥n *</option>
          <option>detenido</option>
          <option>identificado</option>
          <option>investigado</option>
          <option>perjudicado</option>
          <option>requirente</option>
          <option>testigo</option>
        </select>
        <select id="fiSexo" title="Sexo" required>
          <option value="" disabled selected>Sexo *</option>
          <option>Masculino</option>
          <option>Femenino</option>
        </select>

        <input id="fiNombre" type="text" placeholder="Nombre">
        <input id="fiApellidos" type="text" placeholder="Apellidos (MAY√öSC.)">

        <input id="fiNacionalidad" type="text" placeholder="Nacionalidad">
        <input id="fiTipoDoc" type="text" placeholder="Tipo documento">

        <input id="fiNumDoc" type="text" placeholder="N¬∫ Documento">
        <input id="fiFechaNac" type="text" placeholder="Fecha Nacimiento">

        <input id="fiLugarNac" type="text" placeholder="Lugar de nacimiento">
        <input id="fiPadres" type="text" placeholder="Nombre de los Padres">

        <input id="fiDom" type="text" placeholder="Domicilio">
        <input id="fiTel" type="text" placeholder="Tel√©fono">
      </div>

      <!-- Botones A√±adir/Importar (verdes) debajo de los campos -->
      <div style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <button id="btnAddFili" class="btn btn-green" title="Guardar ficha">‚ûï A√±adir</button>
        <label class="btn btn-green" for="fileFili" title="Importar JSON">üì• Importar</label>
        <input id="fileFili" type="file" accept="application/json" style="display:none">
      </div>

      <div class="list" id="filiList"></div>
    </div>
  </div>

  <!-- Texto dictado (sin placeholder) -->
  <textarea id="txt"></textarea>
  <div id="status" class="status"></div>

  <h3 class="section-title">Versi√≥n Policial</h3>
  <div id="out" class="out" contenteditable="true"></div>
</div>

<script>
/* ==================== CONFIG ==================== */
const API_BASE = "https://compa-movil-backend.onrender.com";

/* ==================== UTIL / ESTADO ==================== */
const $ = s => document.querySelector(s);
const statusEl = $('#status'), txt = $('#txt'), out = $('#out');
function setStatus(s){ statusEl.textContent = s; }
function flashRed(el){ el.classList.add('flash-red'); setTimeout(()=>el.classList.remove('flash-red'), 1000); }

/* ==================== STORAGE ==================== */
const LSK_MAP   = "compapol.fili.map";   // visibles (hasta tel√©fono) para UI
const LSK_FULL  = "compapol.fili.full";  // completas importadas (det‚Ä¢pol)
const LSK_EXTRAS= "compapol.extras";     // otros campos top-level importados

function loadMap(){ try{ const v=JSON.parse(localStorage.getItem(LSK_MAP)||"{}"); return v&&typeof v==="object"?v:{}; }catch{ return {}; } }
function saveMap(m){ localStorage.setItem(LSK_MAP, JSON.stringify(m||{})); }
function loadFull(){ try{ const v=JSON.parse(localStorage.getItem(LSK_FULL)||"{}"); return v&&typeof v==="object"?v:{}; }catch{ return {}; } }
function saveFull(m){ localStorage.setItem(LSK_FULL, JSON.stringify(m||{})); }
function loadExtras(){ try{ const v=JSON.parse(localStorage.getItem(LSK_EXTRAS)||"{}"); return v&&typeof v==="object"?v:{}; }catch{ return {}; } }
function saveExtras(e){ localStorage.setItem(LSK_EXTRAS, JSON.stringify(e||{})); }

/* ==================== CAPITALIZACI√ìN ==================== */
/* Apellidos SIEMPRE MAY√öSCULAS. El resto Title Case con excepciones. */
const STOPWORDS = new Set(["de","del","la","las","los","y","o","u","al","el","en","da","do","das","dos"]);
function titleCaseSmart(str){
  if(!str) return "";
  return str.trim().split(/\s+/).map((w,i)=>{
    const low = w.toLowerCase();
    if(i>0 && STOPWORDS.has(low)) return low;
    return low.charAt(0).toUpperCase() + low.slice(1);
  }).join(" ");
}
function toDDMMYYYY(s){
  if (!s) return "";
  const t = s.trim();
  if (/^\d{2}\/\d{2}\/\d{4}$/.test(t)) return t;
  if (/^\d{4}-\d{2}-\d{2}$/.test(t)){ const [Y,M,D]=t.split("-"); return `${D}/${M}/${Y}`; }
  return t; // otros formatos se respetan
}
function normalizeFicha(v){
  const out = {...v};
  out.nombre = titleCaseSmart(out.nombre||"");
  out.nacionalidad = titleCaseSmart(out.nacionalidad||"");
  out.lugar_nacimiento = titleCaseSmart(out.lugar_nacimiento||"");
  out.padres = titleCaseSmart(out.padres||"");
  out.domicilio = titleCaseSmart(out.domicilio||"");
  out.apellidos = (out.apellidos||"").toUpperCase();  // SIEMPRE MAY√öSCULAS
  out.fecha_nacimiento = toDDMMYYYY(out.fecha_nacimiento||"");
  return out;
}

/* ==================== INSERCI√ìN ==================== */
function insertAtCursor(el, text){
  const start = el.selectionStart ?? el.value.length;
  const end = el.selectionEnd ?? el.value.length;
  const before = el.value.slice(0,start);
  const after  = el.value.slice(end);
  el.value = before + text + after;
  const pos = start + text.length;
  el.selectionStart = el.selectionEnd = pos;
  el.focus();
}
function insertHtmlAtCursorInContentEditable(container, html) {
  container.focus();
  const sel = window.getSelection();
  if (!sel || sel.rangeCount === 0) { container.insertAdjacentHTML('beforeend', html); return; }
  const range = sel.getRangeAt(0);
  const temp = document.createElement('div'); temp.innerHTML = html;
  const frag = document.createDocumentFragment(); let node;
  while ((node = temp.firstChild)) frag.appendChild(node);
  range.deleteContents(); range.insertNode(frag);
  sel.removeAllRanges(); const r = document.createRange(); r.selectNodeContents(container); r.collapse(false); sel.addRange(r);
}

/* ==================== FORMATO DE FICHA ==================== */
function formatFichaFull(x){
  const nom=(x.nombre||"").trim(), ape=(x.apellidos||"").trim();
  if(!nom && !ape) return "";
  const segs=[];
  segs.push([nom, ape].filter(Boolean).join(" ").trim());

  const tipo=(x.tipo_doc||"").trim(), num=(x.num_doc||"").trim();
  if (tipo && num) segs.push(`${tipo} ${num}`);
  else if (tipo && !num) segs.push(tipo);
  else if (!tipo && num) segs.push(num);
  else segs.push("indocumentado/a");

  const sx=(x.sexo||"").toLowerCase();
  const nac = sx.startsWith("f") ? "nacida" : sx.startsWith("m") ? "nacido" : "nacido/a";
  const lugar=(x.lugar_nacimiento||"").trim();
  const f=toDDMMYYYY(x.fecha_nacimiento||"");
  const segNac=[]; if(lugar) segNac.push(`en ${lugar}`); if(f) segNac.push(`el ${f}`);
  if (segNac.length) segs.push(`${nac} ${segNac.join(" ")}`);

  if (x.padres && x.padres.trim()){
    const hijo = sx.startsWith("f") ? "hija" : sx.startsWith("m") ? "hijo" : "hijo/a";
    segs.push(`${hijo} de ${x.padres.trim()}`);
  }
  if (x.domicilio && x.domicilio.trim()) segs.push(`domicilio en ${x.domicilio.trim()}`);
  if (x.telefono && x.telefono.trim()) segs.push(`tel√©fono ${x.telefono.trim()}`);
  return segs.join(", ")+".";
}

/* ==================== UI FILIACIONES ==================== */
const list  = $('#filiList');
const accBody = $('#accBody');

function rowLabel(v){
  const n = [ (v.nombre||"").trim(), (v.apellidos||"").trim() ].filter(Boolean).join(" ");
  return n ? n.toUpperCase() : "(SIN NOMBRE)";
}

function rebuildFiliList(){
  const m = loadMap();
  list.innerHTML = "";
  for (const [id,vRaw] of Object.entries(m)){
    const v = normalizeFicha(vRaw);
    m[id] = v; // persistimos normalizado
    const row=document.createElement('div'); row.className='rowItem';
    const l=document.createElement('div'); l.textContent = rowLabel(v);
    const r=document.createElement('div'); r.style.display='flex'; r.style.gap='6px';

    const bT=document.createElement('button'); bT.className='btn'; bT.style.height='32px'; bT.textContent='‚ûïT';
    bT.title='Insertar en Texto';
    bT.onclick=(ev)=>{ flashRed(ev.currentTarget); const t=formatFichaFull(v); if(t) insertAtCursor(txt, t+" "); closeAccordion(); };

    const bR=document.createElement('button'); bR.className='btn'; bR.style.height='32px'; bR.textContent='‚ûïR';
    bR.title='Insertar en Versi√≥n Policial';
    bR.onclick=(ev)=>{ flashRed(ev.currentTarget); const t=formatFichaFull(v); if(t) insertHtmlAtCursorInContentEditable(out, `<p>‚Äî Que ${t}</p>`); closeAccordion(); };

    const bDel=document.createElement('button'); bDel.className='btn'; bDel.style.height='32px'; bDel.textContent='üóëÔ∏è';
    bDel.title='Eliminar ficha';
    bDel.onclick=(ev)=>{ flashRed(ev.currentTarget); const mm = loadMap(); delete mm[id]; saveMap(mm); rebuildFiliList(); setStatus('üóëÔ∏è Ficha eliminada.'); };

    r.appendChild(bT); r.appendChild(bR); r.appendChild(bDel);
    row.appendChild(l); row.appendChild(r);
    list.appendChild(row);
  }
  saveMap(m);
}

/* ==================== FORM / IMPORT / EXPORT ==================== */
const fiCondicion=$('#fiCondicion'), fiSexo=$('#fiSexo'), fiNombre=$('#fiNombre'), fiApellidos=$('#fiApellidos'),
      fiNacionalidad=$('#fiNacionalidad'), fiTipoDoc=$('#fiTipoDoc'), fiNumDoc=$('#fiNumDoc'),
      fiFechaNac=$('#fiFechaNac'), fiLugarNac=$('#fiLugarNac'), fiPadres=$('#fiPadres'),
      fiDom=$('#fiDom'), fiTel=$('#fiTel'), fileFili=$('#fileFili');

function toInternalFromSpanish(obj){
  const base = {
    condicion: obj["Condici√≥n"] ?? obj["condicion"] ?? "",
    sexo: obj["Sexo"] ?? obj["sexo"] ?? "",
    nombre: obj["Nombre"] ?? obj["nombre"] ?? "",
    apellidos: obj["Apellidos"] ?? obj["apellidos"] ?? "",
    nacionalidad: obj["Nacionalidad"] ?? obj["nacionalidad"] ?? "",
    tipo_doc: obj["Tipo de documento"] ?? obj["tipo_doc"] ?? obj["tipoDocumento"] ?? "",
    num_doc: obj["N¬∫ Documento"] ?? obj["numeroDocumento"] ?? obj["num_doc"] ?? obj["N¬∫ documento"] ?? obj["N¬∫"] ?? "",
    fecha_nacimiento: (obj["Fecha de nacimiento"] ?? obj["fecha_nacimiento"] ?? ""),
    lugar_nacimiento: obj["Lugar de nacimiento"] ?? obj["lugar_nacimiento"] ?? "",
    padres: obj["Nombre de los Padres"] ?? obj["padres"] ?? "",
    domicilio: obj["Domicilio"] ?? obj["domicilio"] ?? "",
    telefono: obj["Tel√©fono"] ?? obj["telefono"] ?? ""
  };
  base.fecha_nacimiento = toDDMMYYYY(base.fecha_nacimiento);
  return normalizeFicha(base);
}
function toSpanishFromInternal(v){
  return {
    "Condici√≥n": v.condicion || "",
    "Sexo": v.sexo || "",
    "Nombre": v.nombre || "",
    "Apellidos": v.apellidos || "",
    "Nacionalidad": v.nacionalidad || "",
    "Tipo de documento": v.tipo_doc || "",
    "N¬∫ Documento": v.num_doc || "",
    "Fecha de nacimiento": v.fecha_nacimiento || "",
    "Lugar de nacimiento": v.lugar_nacimiento || "",
    "Nombre de los Padres": v.padres || "",
    "Domicilio": v.domicilio || "",
    "Tel√©fono": v.telefono || ""
  };
}

function closeAccordion(){ $('#accBody').classList.remove('show'); }

/* A√±adir (validaci√≥n Condici√≥n y Sexo) */
$('#btnAddFili').addEventListener('click', (ev)=>{
  flashRed(ev.currentTarget);

  if (!fiCondicion.value) { setStatus('‚ö†Ô∏è Condici√≥n es obligatoria.'); fiCondicion.focus(); return; }
  if (!fiSexo.value) { setStatus('‚ö†Ô∏è Sexo es obligatorio.'); fiSexo.focus(); return; }

  const id = "P"+Date.now();
  const v = normalizeFicha({
    condicion: fiCondicion.value||"",
    sexo: fiSexo.value||"",
    nombre: fiNombre.value||"",
    apellidos: fiApellidos.value||"",
    nacionalidad: fiNacionalidad.value||"",
    tipo_doc: fiTipoDoc.value||"",
    num_doc: fiNumDoc.value||"",
    fecha_nacimiento: toDDMMYYYY(fiFechaNac.value||""),
    lugar_nacimiento: fiLugarNac.value||"",
    padres: fiPadres.value||"",
    domicilio: fiDom.value||"",
    telefono: fiTel.value||""
  });
  const m = loadMap(); m[id]=v; saveMap(m);
  fiCondicion.value=fiSexo.value=fiNombre.value=fiApellidos.value=fiNacionalidad.value=fiTipoDoc.value=fiNumDoc.value=fiFechaNac.value=fiLugarNac.value=fiPadres.value=fiDom.value=fiTel.value="";
  rebuildFiliList(); setStatus("‚úÖ Ficha guardada."); closeAccordion();
});

/* Importar (vincula la ficha COMPLETA al mismo id que la visible; no duplica) */
fileFili.addEventListener('change', async (ev)=>{
  const f = ev.target.files?.[0]; if(!f) return;
  try{
    const txt = await f.text();
    const obj = JSON.parse(txt);
    const m = loadMap(); const fullMap = loadFull();
    let extras = loadExtras();

    const addOne = (raw) => {
      const v = toInternalFromSpanish(raw); // visible/normalizada para UI
      const hasSome = Object.values(v).some(x => (x||"").toString().trim().length);
      if (!hasSome) return;
      const id = "P"+Date.now()+Math.floor(Math.random()*1000);
      m[id] = v;           // visible
      fullMap[id] = raw;   // completa importada (det‚Ä¢pol) vinculada por el mismo id
    };

    if (Array.isArray(obj)) {
      for (const it of obj) if (it && typeof it==="object") addOne(it);
    } else if (obj && typeof obj==="object") {
      const knownTop = new Set(["doc","filiaciones","objects","extras","generales"]);
      const extraTop = {};
      for (const [k,v] of Object.entries(obj)){
        if (!knownTop.has(k)) extraTop[k]=v;
      }
      extras = { ...extras, ...extraTop };

      if (typeof obj.doc === "string") out.innerHTML = obj.doc;

      if (Array.isArray(obj.filiaciones)) {
        for (const val of obj.filiaciones) if (val && typeof val==="object") addOne(val);
      } else if (obj.filiaciones && typeof obj.filiaciones==="object") {
        for (const val of Object.values(obj.filiaciones)) if (val && typeof val==="object") addOne(val);
      } else {
        const keys = Object.keys(obj);
        const labelKeys = ["Condici√≥n","Sexo","Nombre","Apellidos","Nacionalidad","Tipo de documento","N¬∫ Documento","Fecha de nacimiento","Lugar de nacimiento","Nombre de los Padres","Domicilio","Tel√©fono"];
        const isSingle = labelKeys.some(k => k in obj) || labelKeys.some(k => k.toLowerCase() in Object.fromEntries(keys.map(k=>[k.toLowerCase(),true])));
        if (isSingle) addOne(obj);
        else { for (const val of Object.values(obj)) if (val && typeof val==="object") addOne(val); }
      }
      saveExtras(extras);
    } else {
      throw new Error("Formato JSON no v√°lido");
    }

    saveMap(m); saveFull(fullMap); rebuildFiliList(); setStatus("‚úÖ Datos importados."); closeAccordion();
  }catch(e){
    setStatus("‚ùå Error al importar: "+(e.message||e));
  }finally{
    ev.target.value="";
  }
});

/* ==================== AUDIO (grabar/parar) ==================== */
const btnRec = $('#btnRec'), btnRecStop = $('#btnRecStop'), topBar = $('#topBar');
let mediaRecorder=null, recChunks=[], recStream=null;

async function startRecording(ev){
  try{
    flashRed(ev.currentTarget);
    closeAccordion();
    recStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    let mime=''; if (window.MediaRecorder && MediaRecorder.isTypeSupported){
      if (MediaRecorder.isTypeSupported('audio/mp4')) mime='audio/mp4';
      else if (MediaRecorder.isTypeSupported('audio/webm')) mime='audio/webm';
    }
    mediaRecorder = mime ? new MediaRecorder(recStream,{mimeType:mime}) : new MediaRecorder(recStream);
    recChunks=[];
    mediaRecorder.ondataavailable = e=>{ if(e.data && e.data.size) recChunks.push(e.data); };
    mediaRecorder.onstart = ()=> setStatus('üî¥ Grabando‚Ä¶');
    mediaRecorder.onstop = async ()=>{
      try{
        const type = mediaRecorder.mimeType || (recChunks[0]?.type) || 'audio/webm';
        const blob = new Blob(recChunks,{type});
        const ext = type.includes('mp4')?'m4a':type.includes('webm')?'webm':type.includes('wav')?'wav':'webm';
        const file = new File([blob],`grabacion.${ext}`,{type});
        setStatus('‚è≥ Transcribiendo‚Ä¶');
        const fd = new FormData(); fd.append('file',file,file.name);
        const r = await fetch(`${API_BASE}/api/whisper`,{method:'POST', body:fd});
        if(!r.ok){ let msg='HTTP '+r.status; try{const j=await r.json(); if(j?.error) msg+=' ¬∑ '+j.error;}catch{} throw new Error(msg); }
        const { text } = await r.json();
        txt.value = (txt.value ? (txt.value.trim()+" ") : "") + (text||"");
        setStatus('‚úÖ Transcripci√≥n lista.');
      }catch(e){ setStatus('‚ùå Error: '+(e.message||e)); }
      finally{ recStream?.getTracks()?.forEach(t=>t.stop()); recStream=null; mediaRecorder=null; recChunks=[]; }
    };
    mediaRecorder.start(1000);
  }catch(err){ setStatus('‚ùå Micr√≥fono no disponible: '+(err.message||err)); }
}
function stopRecording(ev){ try{ flashRed(ev.currentTarget); if(mediaRecorder && mediaRecorder.state!=='inactive') mediaRecorder.stop(); }catch{} }

/* Cerrar acorde√≥n al interactuar con botonera o √°reas de texto */
topBar.addEventListener('click', closeAccordion);
txt.addEventListener('focus', closeAccordion);
out.addEventListener('focus', closeAccordion);

btnRec.addEventListener('click', startRecording);
btnRecStop.addEventListener('click', stopRecording);

/* ==================== REDACTAR / LIMPIAR / GUARDAR ==================== */
$('#btnDraft').addEventListener('click', async (ev)=>{
  flashRed(ev.currentTarget); closeAccordion();
  const body = JSON.stringify({ texto: txt.value||"", filiaciones:[], objetos:[], fichas_resueltas:[] });
  try{
    setStatus('‚è≥ Generando redacci√≥n‚Ä¶');
    const r = await fetch(`${API_BASE}/api/police-draft`, { method:'POST', headers:{'Content-Type':'application/json'}, body });
    if(!r.ok){ let msg='HTTP '+r.status; try{const j=await r.json(); if(j?.error) msg+=' ¬∑ '+j.error;}catch{} throw new Error(msg); }
    const { html } = await r.json();
    out.innerHTML = html || '';
    setStatus('‚úÖ Redacci√≥n lista.');
  }catch(e){ setStatus('‚ùå Error en redacci√≥n: '+(e.message||e)); }
});

$('#btnClear').addEventListener('click', (ev)=>{
  flashRed(ev.currentTarget); closeAccordion();
  txt.value=''; out.innerHTML=''; setStatus('üßπ Limpio.');
});

/* Descarga JSON: usa la FICHA COMPLETA si existe, sin duplicar; marca principal y genera 'generales' */
$('#btnDownload').addEventListener('click', (ev)=>{
  flashRed(ev.currentTarget); closeAccordion();

  const mapVisible = loadMap();     // visibles (hasta tel√©fono)
  const mapFull    = loadFull();    // completas importadas
  const extras     = loadExtras();

  // Construimos array respetando orden de inserci√≥n; si hay completa, exportamos esa
  const arr = [];
  for (const [id, vis] of Object.entries(mapVisible)) {
    const full = mapFull[id];
    if (full && typeof full === "object") {
      // Normalizamos campos esenciales sin perder el resto:
      const norm = toInternalFromSpanish(full);
      const exported = { ...full };
      exported["Nombre"] = norm.nombre || exported["Nombre"] || "";
      exported["Apellidos"] = (norm.apellidos || exported["Apellidos"] || "").toUpperCase();
      exported["Sexo"] = norm.sexo || exported["Sexo"] || "";
      exported["Nacionalidad"] = norm.nacionalidad || exported["Nacionalidad"] || "";
      exported["Tipo de documento"] = norm.tipo_doc || exported["Tipo de documento"] || "";
      exported["N¬∫ Documento"] = norm.num_doc || exported["N¬∫ Documento"] || "";
      exported["Fecha de nacimiento"] = norm.fecha_nacimiento || exported["Fecha de nacimiento"] || "";
      exported["Lugar de nacimiento"] = norm.lugar_nacimiento || exported["Lugar de nacimiento"] || "";
      exported["Nombre de los Padres"] = norm.padres || exported["Nombre de los Padres"] || "";
      exported["Domicilio"] = norm.domicilio || exported["Domicilio"] || "";
      exported["Tel√©fono"] = norm.telefono || exported["Tel√©fono"] || "";
      // Condici√≥n: preferimos la visible (UI) si existe
      exported["Condici√≥n"] = (vis.condicion || exported["Condici√≥n"] || "").toLowerCase();
      arr.push(exported);
    } else {
      arr.push(toSpanishFromInternal(normalizeFicha(vis)));
    }
  }

  // Elegimos principal: primera con Condici√≥n="detenido" (min√∫sculas). Si no hay, 0.
  let idxPri = arr.findIndex(f => (f["Condici√≥n"]||"").toLowerCase() === "detenido");
  if (idxPri < 0) idxPri = 0;

  // Marcamos la misma ficha como principal
  const principal = { ...arr[idxPri], filiacionTipo: "principal" };

  // Reordenamos para que la principal vaya primera (sin duplicar)
  if (idxPri > 0) {
    arr.splice(idxPri,1);
    arr.unshift(principal);
  } else {
    arr[0] = principal;
  }

  // 'generales' = principal + extras (si los hubiera)
  const generales = { ...principal, ...extras };

  // Payload final
  const payload = {
    doc: out.innerHTML || "",
    filiaciones: arr,
    generales
  };

  // Nombre: Compa dd-mm-aa hh-mmh.json
  const now=new Date();
  const dd=String(now.getDate()).padStart(2,'0');
  const mm=String(now.getMonth()+1).padStart(2,'0');
  const aa=String(now.getFullYear()).slice(-2);
  const hh=String(now.getHours()).padStart(2,'0');
  const mi=String(now.getMinutes()).padStart(2,'0');
  const fname = `Compa ${dd}-${mm}-${aa} ${hh}-${mi}h.json`;

  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = fname;
  a.click();
  setStatus(`üíæ Guardado: ${fname}`);
});

/* ==================== PLEGABLE ==================== */
document.querySelector('#accFili .acc-h').addEventListener('click',()=>{
  $('#accBody').classList.toggle('show');
});

/* ==================== INIT ==================== */
rebuildFiliList();
</script>
</body>
</html>
