<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>COMPAPOL ‚Ä¢ AWAY</title>
<style>
:root{
  --bg-img: url('bg_patrol.png');        /* imagen en la MISMA carpeta */
  --azul:#2b5fff; --ok:#22c55e; --danger:#ef4444; --txt:#fff; --muted:#b5b5b5;
}

/* Fondo a pantalla completa (fijo) */
body::before{
  content:""; position:fixed; inset:0; z-index:-2;
  background-image: var(--bg-img);
  background-size: cover; background-position:center; background-repeat:no-repeat;
  background-attachment: fixed;
}
@supports (-webkit-touch-callout:none){ body::before{ background-attachment:scroll; } }

/* Velo oscuro transl√∫cido */
body::after{
  content:""; position:fixed; inset:0; z-index:-1;
  background: rgba(0,0,0,.40); backdrop-filter: blur(2px);
}

*{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html,body{ height:100%; }
body{ margin:0; color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#000; }

header{ position:sticky; top:0; z-index:5; padding:14px 12px; }
h1{
  margin:0; text-align:center; font-weight:900; letter-spacing:.35px; font-size:18px;
  color:var(--azul); text-shadow:0 0 10px var(--azul), 0 0 24px rgba(43,95,255,.75);
}
.wrap{ padding:12px; max-width:820px; margin:0 auto; }

/* Panel vidrio ahumado */
.glass{
  background: rgba(18,18,18,.60);
  border:1px solid var(--azul);
  border-radius:14px;
  box-shadow: 0 0 6px rgba(43,95,255,.85), 0 0 18px rgba(43,95,255,.55);
  padding:10px;
}

/* Botonera: 5 botones que juntos ocupan el 100% */
.bar{ display:grid; grid-template-columns:repeat(5,minmax(0,1fr)); gap:10px; }
@media (max-width:420px){ .bar{ gap:8px; } }

/* Bot√≥n redondo NE√ìN + icono SVG */
.btn-round{
  width:56px; height:56px; border-radius:50%;
  border:2px solid var(--azul);
  background: radial-gradient(ellipse at center, rgba(30,45,110,.22), rgba(10,14,41,.78) 62%);
  box-shadow:
    0 0 0 1px rgba(43,95,255,.25) inset,
    0 0 12px rgba(43,95,255,.75),
    0 0 28px rgba(43,95,255,.45);
  display:flex; align-items:center; justify-content:center; cursor:pointer;
  transition: transform .08s ease;
  animation: neonPulse 2.4s ease-in-out infinite;
}
.btn-round:active{ transform:translateY(1px) scale(.98); }
.btn-round.flash-red{
  border-color:var(--danger)!important;
  box-shadow:
    0 0 0 1px rgba(239,68,68,.35) inset,
    0 0 14px rgba(239,68,68,.95),
    0 0 34px rgba(239,68,68,.65)!important;
}
@keyframes neonPulse{
  0%,100%{ box-shadow:0 0 0 1px rgba(43,95,255,.25) inset, 0 0 10px rgba(43,95,255,.6), 0 0 24px rgba(43,95,255,.4); }
  50%{ box-shadow:0 0 0 1px rgba(43,95,255,.35) inset, 0 0 14px rgba(43,95,255,.85), 0 0 32px rgba(43,95,255,.55); }
}
/* Icono SVG con brillo */
.icon{ width:26px; height:26px; stroke:var(--azul); fill:none; stroke-width:2.2; stroke-linecap:round; stroke-linejoin:round;
  filter: drop-shadow(0 0 6px rgba(43,95,255,.85)) drop-shadow(0 0 14px rgba(43,95,255,.55));
}

/* Inputs/Selects */
.grid2{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
input[type="text"], select{
  width:100%; height:40px; border-radius:10px; border:1px solid var(--azul);
  background: rgba(14,14,14,.82); color:#fff; padding:0 10px; font-size:14px;
  box-shadow: inset 0 0 0 1px rgba(43,95,255,.08);
}
input::placeholder{ color:var(--muted); opacity:.35; }
select{ background: rgba(14,14,14,.82); color:#fff; }

/* Acorde√≥n */
.accordion{ border:1px solid var(--azul); border-radius:12px; overflow:hidden; margin:10px 0; background: rgba(18,18,18,.60); }
.acc-h{ background: rgba(10,14,41,.55); padding:10px; display:flex; align-items:center; justify-content:center; }
.acc-title{ font-weight:700; text-shadow:0 0 7px rgba(100,150,255,.8); }
.acc-c{ display:none; padding:10px; }
.acc-c.show{ display:block; }

/* Lista de fichas */
.list{ margin-top:8px; display:grid; gap:6px; }
.rowItem{ display:flex; align-items:center; justify-content:space-between; gap:8px;
  padding:6px 8px; background: rgba(20,20,20,.75); border:1px solid var(--azul); border-radius:10px; font-size:13px; }
.rowItem .mini{ width:38px; height:38px; }

/* Texto / Salida */
textarea{
  width:100%; min-height:200px; background: rgba(18,18,18,.60); color:#fff;
  border:1px solid var(--azul); border-radius:12px; padding:10px; font-size:15px; box-shadow: 0 0 6px rgba(43,95,255,.85), 0 0 18px rgba(43,95,255,.55);
}
.status{ font-size:12px; color:var(--muted); min-height:18px; margin:6px 2px 10px; }
.out{ min-height:180px; background: rgba(18,18,18,.60); border:1px solid var(--azul); border-radius:12px; padding:10px; box-shadow: 0 0 6px rgba(43,95,255,.85), 0 0 18px rgba(43,95,255,.55); }
.section-title{ margin:10px 0 6px; text-align:center; font-weight:800; color:var(--azul); text-shadow:0 0 8px rgba(100,150,255,.8); }
</style>
</head>
<body>
<header><h1>COMPAPOL ‚Ä¢ AWAY</h1></header>

<div class="wrap glass">
  <!-- Botonera NE√ìN -->
  <div class="bar" id="topBar">
    <!-- üé§ Grabar -->
    <button id="btnRec" class="btn-round" title="Grabar" aria-label="Grabar">
      <svg class="icon" viewBox="0 0 24 24"><rect x="9" y="2" width="6" height="12" rx="3"/><path d="M5 11v1a7 7 0 0 0 14 0v-1"/><path d="M12 19v3"/></svg>
    </button>
    <!-- ‚è∏Ô∏è Parar -->
    <button id="btnRecStop" class="btn-round" title="Parar" aria-label="Parar">
      <svg class="icon" viewBox="0 0 24 24"><rect x="5" y="5" width="5" height="14" rx="1"/><rect x="14" y="5" width="5" height="14" rx="1"/></svg>
    </button>
    <!-- üèõÔ∏è Redacci√≥n -->
    <button id="btnDraft" class="btn-round" title="Redacci√≥n policial" aria-label="Redacci√≥n">
      <svg class="icon" viewBox="0 0 24 24"><path d="M3 10h18"/><path d="M6 10v8h12v-8"/><path d="M8 10V7l4-3 4 3v3"/></svg>
    </button>
    <!-- üßπ Limpiar -->
    <button id="btnClear" class="btn-round" title="Limpiar" aria-label="Limpiar">
      <svg class="icon" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M19 6l-2 13a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2L5 6"/><path d="M10 11l1 6"/><path d="M14 11l-1 6"/></svg>
    </button>
    <!-- üíæ Guardar -->
    <button id="btnDownload" class="btn-round" title="Guardar JSON" aria-label="Guardar">
      <svg class="icon" viewBox="0 0 24 24"><path d="M12 3v12"/><path d="M8 11l4 4 4-4"/><path d="M5 21h14"/></svg>
    </button>
  </div>

  <!-- Filiaciones -->
  <div class="accordion" id="accFili">
    <div class="acc-h"><span class="acc-title">FILIACIONES</span></div>
    <div class="acc-c" id="accBody">
      <div class="grid2">
        <select id="fiCondicion" required>
          <option value="" disabled selected>Condici√≥n *</option>
          <option>detenido</option><option>identificado</option><option>investigado</option>
          <option>perjudicado</option><option>requirente</option><option>testigo</option>
        </select>
        <select id="fiSexo" required>
          <option value="" disabled selected>Sexo *</option>
          <option>Masculino</option><option>Femenino</option>
        </select>
        <input id="fiNombre" type="text" placeholder="Nombre">
        <input id="fiApellidos" type="text" placeholder="Apellidos (MAY√öSC.)">
        <input id="fiNacionalidad" type="text" placeholder="Nacionalidad">
        <input id="fiTipoDoc" type="text" placeholder="Tipo documento">
        <input id="fiNumDoc" type="text" placeholder="N¬∫ Documento">
        <input id="fiFechaNac" type="text" placeholder="Fecha Nacimiento">
        <input id="fiLugarNac" type="text" placeholder="Lugar de nacimiento">
        <input id="fiPadres" type="text" placeholder="Nombre de los Padres">
        <input id="fiDom" type="text" placeholder="Domicilio">
        <input id="fiTel" type="text" placeholder="Tel√©fono">
      </div>
      <div style="margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <button id="btnAddFili" class="btn-round mini" title="Guardar ficha">
          <svg class="icon" viewBox="0 0 24 24"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
        </button>
        <label class="btn-round mini" for="fileFili" title="Importar JSON" style="display:flex;align-items:center;justify-content:center;cursor:pointer;">
          <svg class="icon" viewBox="0 0 24 24"><path d="M12 3v12"/><path d="M8 11l4 4 4-4"/><path d="M5 21h14"/></svg>
        </label>
        <input id="fileFili" type="file" accept="application/json" style="display:none">
      </div>
      <div class="list" id="filiList"></div>
    </div>
  </div>

  <!-- Texto dictado -->
  <textarea id="txt"></textarea>
  <div id="status" class="status"></div>

  <h3 class="section-title">VERSI√ìN POLICIAL</h3>
  <div id="out" class="out" contenteditable="true"></div>
</div>

<script>
/* ==================== CONFIG ==================== */
const API_BASE = "https://compa-movil-backend.onrender.com";

/* ==================== UTIL / ESTADO ==================== */
const $ = s => document.querySelector(s);
const statusEl = $('#status'), txt = $('#txt'), out = $('#out');
function setStatus(s){ statusEl.textContent = s; }
function flashRed(el){ el.classList.add('flash-red'); setTimeout(()=>el.classList.remove('flash-red'), 900); }
function closeAccordion(){ $('#accBody').classList.remove('show'); }

/* ==================== STORAGE ==================== */
const LSK_MAP="compapol.fili.map", LSK_FULL="compapol.fili.full", LSK_EXTRAS="compapol.extras";
const load = k => { try{ const v=JSON.parse(localStorage.getItem(k)||"{}"); return v&&typeof v==="object"?v:{}; }catch{ return {}; } };
const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v||{}));
const loadMap = ()=>load(LSK_MAP),  saveMap=v=>save(LSK_MAP,v);
const loadFull= ()=>load(LSK_FULL), saveFull=v=>save(LSK_FULL,v);
const loadExtras=()=>load(LSK_EXTRAS), saveExtras=v=>save(LSK_EXTRAS,v);

/* ==================== CAPITALIZACI√ìN ==================== */
const STOPWORDS=new Set(["de","del","la","las","los","y","o","u","al","el","en","da","do","das","dos"]);
const tc=s=>!s?"":s.trim().split(/\s+/).map((w,i)=>{const a=w.toLowerCase();return i>0&&STOPWORDS.has(a)?a:a[0].toUpperCase()+a.slice(1)}).join(" ");
const ddmmyyyy=s=>{ if(!s) return ""; const t=s.trim(); if(/^\d{2}\/\d{2}\/\d{4}$/.test(t)) return t; if(/^\d{4}-\d{2}-\d{2}$/.test(t)){const [Y,M,D]=t.split("-"); return `${D}/${M}/${Y}`;} return t; };
const norm=v=>({ ...v,
  nombre:tc(v.nombre||""), nacionalidad:tc(v.nacionalidad||""), lugar_nacimiento:tc(v.lugar_nacimiento||""),
  padres:tc(v.padres||""), domicilio:tc(v.domicilio||""), apellidos:(v.apellidos||"").toUpperCase(), fecha_nacimiento:ddmmyyyy(v.fecha_nacimiento||"")
});

/* ==================== INSERCI√ìN ==================== */
function insertAtCursor(el, text){
  const s=el.selectionStart??el.value.length, e=el.selectionEnd??el.value.length;
  el.value = el.value.slice(0,s) + text + el.value.slice(e);
  el.selectionStart = el.selectionEnd = s + text.length; el.focus();
}
function insertHtmlAtCursorInContentEditable(container, html){
  container.focus(); const sel=window.getSelection(); if(!sel||!sel.rangeCount){ container.insertAdjacentHTML('beforeend', html); return; }
  const r=sel.getRangeAt(0), t=document.createElement('div'); t.innerHTML=html; const f=document.createDocumentFragment(); let n;
  while((n=t.firstChild)) f.appendChild(n); r.deleteContents(); r.insertNode(f);
}

/* ==================== FORMATO FRASE ==================== */
function frase(x){
  const n=(x.nombre||"").trim(), a=(x.apellidos||"").trim(); if(!n&&!a) return "";
  const seg=[]; seg.push([n,a].filter(Boolean).join(" ").trim());
  const td=(x.tipo_doc||"").trim(), nd=(x.num_doc||"").trim();
  if(td&&nd) seg.push(`${td} ${nd}`); else if(td) seg.push(td); else if(nd) seg.push(nd); else seg.push("indocumentado/a");
  const sx=(x.sexo||"").toLowerCase(), nac=sx.startsWith("f")?"nacida":sx.startsWith("m")?"nacido":"nacido/a";
  const lug=(x.lugar_nacimiento||"").trim(), f=ddmmyyyy(x.fecha_nacimiento||""); const sN=[]; if(lug) sN.push(`en ${lug}`); if(f) sN.push(`el ${f}`);
  if(sN.length) seg.push(`${nac} ${sN.join(" ")}`);
  if(x.padres?.trim()){ const hijo=sx.startsWith("f")?"hija":sx.startsWith("m")?"hijo":"hijo/a"; segs=seg.push(`${hijo} de ${x.padres.trim()}`); }
  if(x.domicilio?.trim()) seg.push(`domicilio en ${x.domicilio.trim()}`);
  if(x.telefono?.trim()) seg.push(`tel√©fono ${x.telefono.trim()}`);
  return seg.join(", ")+".";
}

/* ==================== UI FILIACIONES ==================== */
const list=$('#filiList');
function label(v){ const n=[(v.nombre||"").trim(),(v.apellidos||"").trim()].filter(Boolean).join(" "); return n? n.toUpperCase():"(SIN NOMBRE)"; }
function rebuild(){
  const m=loadMap(); list.innerHTML="";
  for(const [id,raw] of Object.entries(m)){
    const v=norm(raw); m[id]=v;
    const row=document.createElement('div'); row.className='rowItem';
    const l=document.createElement('div'); l.textContent=label(v);
    const r=document.createElement('div'); r.style.display='flex'; r.style.gap='6px';

    const bT=document.createElement('button'); bT.className='btn-round mini'; bT.title='Insertar en Texto';
    bT.innerHTML='<svg class="icon" viewBox="0 0 24 24"><path d="M12 5v14"/><path d="M5 12h14"/></svg>';
    bT.onclick=e=>{ flashRed(e.currentTarget); const t=frase(v); if(t) insertAtCursor(txt, t+" "); closeAccordion(); };

    const bR=document.createElement('button'); bR.className='btn-round mini'; bR.title='Insertar en Versi√≥n Policial';
    bR.innerHTML='<svg class="icon" viewBox="0 0 24 24"><path d="M3 12h18"/><path d="M8 8l4-3 4 3"/><path d="M8 12v6h8v-6"/></svg>';
    bR.onclick=e=>{ flashRed(e.currentTarget); const t=frase(v); if(t) insertHtmlAtCursorInContentEditable(out, `<p>‚Äî Que ${t}</p>`); closeAccordion(); };

    const bDel=document.createElement('button'); bDel.className='btn-round mini'; bDel.title='Eliminar ficha';
    bDel.innerHTML='<svg class="icon" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M7 6l1 12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2l1-12"/><path d="M10 11l1 6"/><path d="M14 11l-1 6"/></svg>';
    bDel.onclick=e=>{ flashRed(e.currentTarget); const mm=loadMap(); delete mm[id]; saveMap(mm); rebuild(); setStatus('üóëÔ∏è Ficha eliminada.'); };

    r.appendChild(bT); r.appendChild(bR); r.appendChild(bDel);
    row.appendChild(l); row.appendChild(r); list.appendChild(row);
  }
  saveMap(m);
}

/* ==================== FORM / IMPORT / EXPORT ==================== */
const fiCondicion=$('#fiCondicion'), fiSexo=$('#fiSexo'), fiNombre=$('#fiNombre'), fiApellidos=$('#fiApellidos'),
      fiNacionalidad=$('#fiNacionalidad'), fiTipoDoc=$('#fiTipoDoc'), fiNumDoc=$('#fiNumDoc'),
      fiFechaNac=$('#fiFechaNac'), fiLugarNac=$('#fiLugarNac'), fiPadres=$('#fiPadres'),
      fiDom=$('#fiDom'), fiTel=$('#fiTel'), fileFili=$('#fileFili');

function toInternal(obj){
  const b={
    condicion: obj["Condici√≥n"]??obj["condicion"]??"",
    sexo: obj["Sexo"]??obj["sexo"]??"",
    nombre: obj["Nombre"]??obj["nombre"]??"",
    apellidos: obj["Apellidos"]??obj["apellidos"]??"",
    nacionalidad: obj["Nacionalidad"]??obj["nacionalidad"]??"",
    tipo_doc: obj["Tipo de documento"]??obj["tipo_doc"]??obj["tipoDocumento"]??"",
    num_doc: obj["N¬∫ Documento"]??obj["numeroDocumento"]??obj["num_doc"]??obj["N¬∫ documento"]??obj["N¬∫"]??"",
    fecha_nacimiento: obj["Fecha de nacimiento"]??obj["fecha_nacimiento"]??"",
    lugar_nacimiento: obj["Lugar de nacimiento"]??obj["lugar_nacimiento"]??"",
    padres: obj["Nombre de los Padres"]??obj["padres"]??"",
    domicilio: obj["Domicilio"]??obj["domicilio"]??"",
    telefono: obj["Tel√©fono"]??obj["telefono"]??""
  };
  b.fecha_nacimiento = ddmmyyyy(b.fecha_nacimiento); return norm(b);
}
function toSpanish(v){
  return {
    "Condici√≥n": v.condicion||"", "Sexo": v.sexo||"", "Nombre": v.nombre||"", "Apellidos": v.apellidos||"",
    "Nacionalidad": v.nacionalidad||"", "Tipo de documento": v.tipo_doc||"", "N¬∫ Documento": v.num_doc||"",
    "Fecha de nacimiento": v.fecha_nacimiento||"", "Lugar de nacimiento": v.lugar_nacimiento||"",
    "Nombre de los Padres": v.padres||"", "Domicilio": v.domicilio||"", "Tel√©fono": v.telefono||""
  };
}

/* A√±adir ficha */
$('#btnAddFili').addEventListener('click', e=>{
  flashRed(e.currentTarget);
  if(!fiCondicion.value){ setStatus('‚ö†Ô∏è Condici√≥n es obligatoria.'); fiCondicion.focus(); return; }
  if(!fiSexo.value){ setStatus('‚ö†Ô∏è Sexo es obligatorio.'); fiSexo.focus(); return; }
  const id="P"+Date.now();
  const v=norm({
    condicion:fiCondicion.value, sexo:fiSexo.value, nombre:fiNombre.value, apellidos:fiApellidos.value,
    nacionalidad:fiNacionalidad.value, tipo_doc:fiTipoDoc.value, num_doc:fiNumDoc.value,
    fecha_nacimiento:fiFechaNac.value, lugar_nacimiento:fiLugarNac.value, padres:fiPadres.value,
    domicilio:fiDom.value, telefono:fiTel.value
  });
  const m=loadMap(); m[id]=v; saveMap(m);
  fiCondicion.value=fiSexo.value=fiNombre.value=fiApellidos.value=fiNacionalidad.value=fiTipoDoc.value=fiNumDoc.value=fiFechaNac.value=fiLugarNac.value=fiPadres.value=fiDom.value=fiTel.value="";
  rebuild(); setStatus("‚úÖ Ficha guardada."); closeAccordion();
});

/* Importar (vincula completa con el mismo id) */
fileFili.addEventListener('change', async ev=>{
  const f=ev.target.files?.[0]; if(!f) return;
  try{
    const txt=await f.text(); const obj=JSON.parse(txt);
    const m=loadMap(); const full=loadFull(); let extras=loadExtras();
    const addOne = raw => { const v=toInternal(raw); const ok=Object.values(v).some(x=>(x||"").toString().trim().length); if(!ok) return;
      const id="P"+Date.now()+Math.floor(Math.random()*1000); m[id]=v; full[id]=raw; };
    if(Array.isArray(obj)){ obj.forEach(x=>x&&typeof x==="object"&&addOne(x)); }
    else if(obj && typeof obj==="object"){
      const known=new Set(["doc","filiaciones","objects","extras","generales"]); const top={};
      for(const [k,v] of Object.entries(obj)){ if(!known.has(k)) top[k]=v; } extras={...extras,...top};
      if(typeof obj.doc==="string") out.innerHTML=obj.doc;
      if(Array.isArray(obj.filiaciones)) obj.filiaciones.forEach(x=>x&&typeof x==="object"&&addOne(x));
      else if(obj.filiaciones&&typeof obj.filiaciones==="object") Object.values(obj.filiaciones).forEach(x=>x&&typeof x==="object"&&addOne(x));
      else{
        const keys=Object.keys(obj), labels=["Condici√≥n","Sexo","Nombre","Apellidos","Nacionalidad","Tipo de documento","N¬∫ Documento","Fecha de nacimiento","Lugar de nacimiento","Nombre de los Padres","Domicilio","Tel√©fono"];
        const isOne=labels.some(k=>k in obj)||labels.some(k=>k.toLowerCase() in Object.fromEntries(keys.map(k=>[k.toLowerCase(),1])));
        if(isOne) addOne(obj); else Object.values(obj).forEach(x=>x&&typeof x==="object"&&addOne(x));
      }
      saveExtras(extras);
    } else throw new Error("Formato JSON no v√°lido");
    saveMap(m); saveFull(full); rebuild(); setStatus("‚úÖ Datos importados."); closeAccordion();
  }catch(e){ setStatus("‚ùå Error al importar: "+(e.message||e)); }
  finally{ ev.target.value=""; }
});

/* Micr√≥fono (Whisper) */
const btnRec=$('#btnRec'), btnRecStop=$('#btnRecStop');
let mediaRecorder=null, recChunks=[], recStream=null;
async function startRec(e){
  try{
    flashRed(e.currentTarget); closeAccordion();
    recStream=await navigator.mediaDevices.getUserMedia({audio:true});
    let mime=''; if(window.MediaRecorder&&MediaRecorder.isTypeSupported){
      if(MediaRecorder.isTypeSupported('audio/mp4')) mime='audio/mp4'; else if(MediaRecorder.isTypeSupported('audio/webm')) mime='audio/webm';
    }
    mediaRecorder = mime? new MediaRecorder(recStream,{mimeType:mime}) : new MediaRecorder(recStream);
    recChunks=[]; mediaRecorder.ondataavailable=ev=>{ if(ev.data?.size) recChunks.push(ev.data); };
    mediaRecorder.onstart=()=>setStatus('üî¥ Grabando‚Ä¶');
    mediaRecorder.onstop=async ()=>{
      try{
        const type=mediaRecorder.mimeType || recChunks[0]?.type || 'audio/webm';
        const blob=new Blob(recChunks,{type}); const ext=type.includes('mp4')?'m4a':type.includes('webm')?'webm':'webm';
        const file=new File([blob],`grabacion.${ext}`,{type});
        setStatus('‚è≥ Transcribiendo‚Ä¶'); const fd=new FormData(); fd.append('file',file,file.name);
        const r=await fetch(`${API_BASE}/api/whisper`,{method:'POST', body:fd});
        if(!r.ok){ let msg='HTTP '+r.status; try{const j=await r.json(); if(j?.error) msg+=' ¬∑ '+j.error;}catch{} throw new Error(msg); }
        const { text }=await r.json(); txt.value=(txt.value? (txt.value.trim()+" ") : "")+(text||""); setStatus('‚úÖ Transcripci√≥n lista.');
      }catch(err){ setStatus('‚ùå Error: '+(err.message||err)); }
      finally{ recStream?.getTracks()?.forEach(t=>t.stop()); recStream=null; mediaRecorder=null; recChunks=[]; }
    };
    mediaRecorder.start(1000);
  }catch(err){ setStatus('‚ùå Micr√≥fono no disponible: '+(err.message||err)); }
}
function stopRec(e){ try{ flashRed(e.currentTarget); if(mediaRecorder && mediaRecorder.state!=='inactive') mediaRecorder.stop(); }catch{} }
btnRec.addEventListener('click', startRec);
btnRecStop.addEventListener('click', stopRec);

/* Redacci√≥n / Limpiar / Guardar */
$('#btnDraft').addEventListener('click', async e=>{
  flashRed(e.currentTarget); closeAccordion();
  try{
    setStatus('‚è≥ Generando redacci√≥n‚Ä¶');
    const r=await fetch(`${API_BASE}/api/police-draft`,{method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ texto: txt.value||"", filiaciones:[], objetos:[], fichas_resueltas:[] })});
    if(!r.ok){ let msg='HTTP '+r.status; try{const j=await r.json(); if(j?.error) msg+=' ¬∑ '+j.error;}catch{} throw new Error(msg); }
    const { html }=await r.json(); out.innerHTML=html||''; setStatus('‚úÖ Redacci√≥n lista.');
  }catch(err){ setStatus('‚ùå Error en redacci√≥n: '+(err.message||err)); }
});
$('#btnClear').addEventListener('click', e=>{ flashRed(e.currentTarget); closeAccordion(); txt.value=''; out.innerHTML=''; setStatus('üßπ Limpio.'); });
$('#btnDownload').addEventListener('click', e=>{
  flashRed(e.currentTarget); closeAccordion();
  const map=loadMap(), full=loadFull(), extras=loadExtras(); const arr=[];
  for(const [id,vis] of Object.entries(map)){
    const f=full[id];
    if(f&&typeof f==="object"){
      const n=toInternal(f), ex={...f};
      ex["Nombre"]=n.nombre||ex["Nombre"]||""; ex["Apellidos"]=(n.apellidos||ex["Apellidos"]||"").toUpperCase();
      ex["Sexo"]=n.sexo||ex["Sexo"]||""; ex["Nacionalidad"]=n.nacionalidad||ex["Nacionalidad"]||"";
      ex["Tipo de documento"]=n.tipo_doc||ex["Tipo de documento"]||""; ex["N¬∫ Documento"]=n.num_doc||ex["N¬∫ Documento"]||"";
      ex["Fecha de nacimiento"]=n.fecha_nacimiento||ex["Fecha de nacimiento"]||"";
      ex["Lugar de nacimiento"]=n.lugar_nacimiento||ex["Lugar de nacimiento"]||"";
      ex["Nombre de los Padres"]=n.padres||ex["Nombre de los Padres"]||"";
      ex["Domicilio"]=n.domicilio||ex["Domicilio"]||""; ex["Tel√©fono"]=n.telefono||ex["Tel√©fono"]||"";
      ex["Condici√≥n"]=(vis.condicion||ex["Condici√≥n"]||"").toLowerCase();
      arr.push(ex);
    }else{
      arr.push(toSpanish(vis));
    }
  }
  let idx = arr.findIndex(f=>(f["Condici√≥n"]||"").toLowerCase()==="detenido"); if(idx<0) idx=0;
  const principal={...arr[idx], filiacionTipo:"principal"};
  if(idx>0){ arr.splice(idx,1); arr.unshift(principal); } else { arr[0]=principal; }
  const payload={ doc: out.innerHTML||"", filiaciones: arr, generales: { ...principal, ...extras } };
  const now=new Date(), dd=String(now.getDate()).padStart(2,'0'), mm=String(now.getMonth()+1).padStart(2,'0'), aa=String(now.getFullYear()).slice(-2), hh=String(now.getHours()).padStart(2,'0'), mi=String(now.getMinutes()).padStart(2,'0');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:"application/json"})); a.download=`Compa ${dd}-${mm}-${aa} ${hh}-${mi}h.json`; a.click();
  setStatus('üíæ Guardado.');
});

/* Acorde√≥n toggle */
document.querySelector('#accFili .acc-h').addEventListener('click',()=>$('#accBody').classList.toggle('show'));

/* Init */
rebuild();
</script>
</body>
</html>
